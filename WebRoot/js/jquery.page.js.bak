/*********************************************************
                    基于Jquery1.11.3版本
*********************************************************/
(function($) {

    /***************************************************
                     jquery分页查询功能
    ***************************************************/
	 
    /*******************************************************
                         修改日志
             2016.04.18 新增按钮动作绑定监听
             2016.04.28 新增数据遍历参数值jsontype（用于分辨主表数据和不同lov的表格数据）
             2016.05.06 修改html标签data数据传入格式，由字符串改为json数组传入
             2016.05.10 新增隐藏空白行功能，当当前页数据不足一页时，自动遍历设置空白行display:none
             2016.05.11
    *******************************************************/
                                       
	
	/******************listener start***********************
	              监听 data-pagetype 传递的值
	       暂时只设置对<input> <button> <a> <i> 四种标签的绑定
	                如需为其他更多元素增加点击弹出框效果
	                请在listener区域绑定新的监听标签
    *********************************************************/
	$.fn.pageListener = function(){ 
		$('input[data-pagetype]').on('click', function(e) {		
			$(this).page($(this).data());
		});
	
		$('button[data-pagetype]').on('click', function(e) {
			$(this).page($(this).data());
		});
	
		$('a[data-pagetype]').on('click', function(e) {
			e.preventDefault();//阻止<a>标签默认的点击事件（超链接跳转）
			$(this).page($(this).data());
		});
	
		$('i[data-pagetype]').on('click', function(e) {
			$(this).page($(this).data());
		});
	}   
	/******************listener end***********************/	
	
	$().pageListener();//执行监听函数

    $.fn.page = function(options) {	
        
		/***************************
                  设置默认属性
        ***************************/	    
		var defaults={
			pagesetting:'{"loading":"","firstpage":"","lastpage":"","prevpage":"","nextpage":"","setpagesize":"","pagesize":"","pageno":"","pagerow":"","tablename":""}'
		}
		
		//继承默认属性
        var options = $.extend({}, defaults, options); 
		
		jQuery.global={
        	/*
       	    pageFlag:function(firstPageFlag,lastPageFlag){
       	    	if(firstPageFlag=='true'){
       				$(options.pagesetting.prevpage).css('display','none');
       				$(options.pagesetting.firstpage).css('display','none');
       			}
       			else{
       				$(options.pagesetting.prevpage).css('display','');
       				$(options.pagesetting.firstpage).css('display','');
       			}
       			if(lastPageFlag=='true'){
        			$(options.pagesetting.lastpage).css('display','none');
       				$(options.pagesetting.nextpage).css('display','none');
       			}
       			else{
       				$(options.pagesetting.lastpage).css('display','');
       				$(options.pagesetting.nextpage).css('display','');
       			}
       	    },*/
		
		    main:function(){
		    	jQuery.json.setQueryParam();
		    	if(options.pagetype=='lastpage'){
		    		param=param+'&pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=true';
		    	}else{
		    		param=param+'&pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false';
		    	}			
				queryurl=options.queryurl;
				if(queryurl==undefined){
					queryurl=$(options.pagesetting.urltd).val();
				}
				$.ajax({
					async:true,
					type:'post', 
					data:param,
					url:queryurl,
					dataType:'json',
					success: function (data) {
						$(options.pagesetting.tablename+' td').html('');
						jQuery.json.getMSG(data);
						$(options.pagesetting.tablename+' tr').css('display','');
						if(parseInt(data.pageMinRow)!=0){
							jsontype=options.jsontype;
							if(jsontype==undefined){
								jsontype=$(options.pagesetting.typetd).val();
							}
							jQuery.json.getContent(data,jsontype);
							for(j=0;j<=(pageSize-(pageMaxRow-pageMinRow+1));j++){
		                	    $(options.pagesetting.tablename+' tr:eq('+(pageSize-j+1)+')').css('display','none');
		                	}
							if(firstPageFlag=='true'){
			       				$(options.pagesetting.prevpage).css('display','none');
			       				$(options.pagesetting.firstpage).css('display','none');
			       			}else{
			       				$(options.pagesetting.prevpage).css('display','');
			       				$(options.pagesetting.firstpage).css('display','');
			       			}
			       			if(lastPageFlag=='true'){
			        			$(options.pagesetting.lastpage).css('display','none');
			       				$(options.pagesetting.nextpage).css('display','none');
			       			}else{
			       				$(options.pagesetting.lastpage).css('display','');
			       				$(options.pagesetting.nextpage).css('display','');
			       			}
							if(pageMinRow!=pageMaxRow){
								$(options.pagesetting.pagerow).text(pageMinRow+'-'+pageMaxRow);
							}else{
								$(options.pagesetting.pagerow).text(pageMaxRow);
							}
							if(options.pagetype=='setpagesize'){
								$('.title a',$('#setting')).click();
							}else if(options.pagetype=='lastpage'){
								$(options.pagesetting.pageno).val(parseInt(totalPages));
							}
						}else{
							if(options.pagetype=='nextpage'){
								alert("当前页无数据,即将自动跳转到最后一页");
								$(options.pagesetting.prevpage).click();
							}
						}
						$(options.pagesetting.loading).hide();
					},
					error: function () {
						if(options.pagetype=='lastpage'){
						    $(options.tablename+' td').html('');
						    alert("当前页无数据");
						    $(options.pagesetting.pagerow).text('');
						    $(options.pagesetting.loading).hide();
						}else{
							alert("获取Json数据失败");
						}						
					}
				});	
		    }
       	}
		
	
        return this.each(function() {
            
			if(options.pagetype=='refresh'){
				$(options.pagesetting.loading).show();
				pageSize=parseInt($(options.pagesetting.pagesize).val());
				pageNo=parseInt($(options.pagesetting.pageno).val());
				$('td',$('tr:eq(1)')).html('');
				blank_tr=$('tr:eq(1)',$(options.pagesetting.tablename));
				$('td',$(options.pagesetting.tablename)).parent().remove();
				for(j=1;j<=pageSize;j++){
					$('tr:eq(0)',$(options.pagesetting.tablename)).parent().append(blank_tr.clone());
				}
				jQuery.global.main();
			}
					//jQuery.json.setQueryParam();
					/*
					param='pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false';
					$.ajax({
						type:'post', 
						data:param,
						url:options.queryurl,
						dataType:'json',
						success: function (data) {;
							jQuery.json.getMSG(data);
							if(pageMinRow!=0){
								$(options.pagesetting.tablename+' tr').css('display','');
								jQuery.json.getContent(data,options.jsontype);
								for(j=0;j<=(pageSize-(pageMaxRow-pageMinRow+1));j++){
			                	    $(options.pagesetting.tablename+' tr:eq('+(pageSize-j+1)+')').css('display','none');
			                	}
								if(pageMinRow!=pageMaxRow){
									$(options.pagesetting.pagerow).text(pageMinRow+'-'+pageMaxRow);
								}
								else{
									$(options.pagesetting.pagerow).text(pageMaxRow);
								}
							}
							jQuery.global.pageFlag(firstPageFlag,lastPageFlag);
							$(options.pagesetting.loading).hide();
						},
						error: function () {
							alert("获取Json数据失败");
						}
					});
					
				//});
            }*/
			
			else if(options.pagetype=='firstpage'){
				$(options.pagesetting.loading).show();
				pageSize=parseInt($(options.pagesetting.pagesize).val());
				pageNo=parseInt(1);
				$(options.pagesetting.pageno).val(1);
				jQuery.global.main();
			}
					//jQuery.json.setQueryParam();
					/*
					param='pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false';
					$.ajax({
						type:'post', 
						data:param,
						url:options.queryurl,//+'?pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false',
						dataType:'json',
						success: function (data) {
							$(options.pagesetting.tablename+' td').html('');
							jQuery.json.getMSG(data);
							$(options.pagesetting.tablename+' tr').css('display','');
							jQuery.json.getContent(data,options.jsontype);
							for(j=0;j<=(pageSize-(pageMaxRow-pageMinRow+1));j++){
		                	    $(options.pagesetting.tablename+' tr:eq('+(pageSize-j+1)+')').css('display','none');
		                	}
							jQuery.global.pageFlag(firstPageFlag,lastPageFlag);
							if(pageMinRow!=pageMaxRow){
								$(options.pagesetting.pagerow).text(pageMinRow+'-'+pageMaxRow);
							}
							else{
								$(options.pagesetting.pagerow).text(pageMaxRow);
							}	
							$(options.pagesetting.loading).hide();
						},
						error: function () {
							alert("获取Json数据失败");
						}
					});
				//});		
			}*/
			
			else if(options.pagetype=='lastpage'){
				$(options.pagesetting.loading).show();
				pageSize=parseInt($(options.pagesetting.pagesize).val());
				pageNo=parseInt($(options.pagesetting.pageno).val());
				pageNo=pageNo+1;
				jQuery.global.main();
			}
					//jQuery.json.setQueryParam();
					/*
					param='pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=true';
					$.ajax({
						type:'post', 
						data:param,
						url:options.queryurl,//+'?pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=true',
						dataType:'json',
						success: function (data) {
							$(options.pagesetting.tablename+' td').html('');
							jQuery.json.getMSG(data);
							$(options.pagesetting.tablename+' tr').css('display','');
							jQuery.json.getContent(data,options.jsontype);
							for(j=0;j<=(pageSize-(pageMaxRow-pageMinRow+1));j++){
		                	    $(options.pagesetting.tablename+' tr:eq('+(pageSize-j+1)+')').css('display','none');
		                	}
							jQuery.global.pageFlag(firstPageFlag,lastPageFlag);
							$(options.pagesetting.pageno).val(parseInt(totalPages));
							if(pageMinRow!=pageMaxRow){
								$(options.pagesetting.pagerow).text(pageMinRow+'-'+pageMaxRow);
							}
							else{
								$(options.pagesetting.pagerow).text(pageMaxRow);
							}	
							$(options.pagesetting.loading).hide();
						},
						error: function () {
							$(options.tablename+' td').html('');
							alert("当前页无数据");
							$(options.pagesetting.pagerow).text('');
							$(options.pagesetting.loading).hide();
						}
					});
				//});		
			}
			*/
			
			else if(options.pagetype=='nextpage'){
				$(options.pagesetting.loading).show();
				pageSize=parseInt($(options.pagesetting.pagesize).val());	
				pageNo=parseInt($(options.pagesetting.pageno).val());
				pageNo=pageNo+1;
				$(options.pagesetting.pageno).val(pageNo);
				jQuery.global.main();
			}
					/*
					jQuery.json.setQueryParam();
					param=param+'&pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false';
					queryurl=options.queryurl;
					if(queryurl==undefined){
						queryurl=$(options.pagesetting.urltd).val();
					}
					$.ajax({
						async:true,
						type:'post', 
						data:param,
						url:queryurl,
						dataType:'json',
						success: function (data) {
							$(options.pagesetting.tablename+' td').html('');
							jQuery.json.getMSG(data);
							$(options.pagesetting.tablename+' tr').css('display','');
							if(parseInt(data.pageMinRow)!=0){
								jsontype=options.jsontype;
								if(jsontype==undefined){
									jsontype=$(options.pagesetting.typetd).val();
								}
								jQuery.json.getContent(data,jsontype);
								for(j=0;j<=(pageSize-(pageMaxRow-pageMinRow+1));j++){
			                	    $(options.pagesetting.tablename+' tr:eq('+(pageSize-j+1)+')').css('display','none');
			                	}
								jQuery.global.pageFlag(firstPageFlag,lastPageFlag);
								if(pageMinRow!=pageMaxRow){
									$(options.pagesetting.pagerow).text(pageMinRow+'-'+pageMaxRow);
								}
								else{
									$(options.pagesetting.pagerow).text(pageMaxRow);
								}
							}
							else{
								alert("当前页无数据,即将自动跳转到最后一页");
								//$(options.lastPage).click();
								$(options.pagesetting.prevpage).click();
								firstPageFlag=false;
								lastPageFlag=true;
								jQuery.global.pageFlag(firstPageFlag,lastPageFlag); 
							}
							$(options.pagesetting.loading).hide();
						},
						error: function () {
							alert("获取Json数据失败");
						}
					});
				//});		
			}*/
			
			else if(options.pagetype=='prevpage'){
				$(options.pagesetting.loading).show();
				pageSize=parseInt($(options.pagesetting.pagesize).val());		
				pageNo=parseInt($(options.pagesetting.pageno).val());
				pageNo=pageNo-1;
				$(options.pagesetting.pageno).val(pageNo);
				jQuery.global.main();
			}
					/*
					jQuery.json.setQueryParam();
					param=param+'&pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false';
					queryurl=options.queryurl;
					if(queryurl==undefined){
						queryurl=$(options.pagesetting.urltd).val();
					}
					$.ajax({
						type:'post', 
						data:param,
						url:queryurl,
						dataType:'json',
						success: function (data) {
							$(options.pagesetting.tablename+' td').html('');
							jQuery.json.getMSG(data);
							jsontype=options.jsontype;
							$(options.pagesetting.tablename+' tr').css('display','');
							if(jsontype==undefined){
								jsontype=$(options.pagesetting.typetd).val();
							}
							jQuery.json.getContent(data,jsontype);
							for(j=0;j<=(pageSize-(pageMaxRow-pageMinRow+1));j++){
		                	    $(options.pagesetting.tablename+' tr:eq('+(pageSize-j+1)+')').css('display','none');
		                	}
							jQuery.global.pageFlag(firstPageFlag,lastPageFlag); 
							if(pageMinRow!=pageMaxRow){
								$(options.pagesetting.pagerow).text(pageMinRow+'-'+pageMaxRow);
							}
							else{
								$(options.pagesetting.pagerow).text(pageMaxRow);
							}	
							$(options.pagesetting.loading).hide();
						},
						error: function () {
							alert("获取Json数据失败");
						}
					});
				//});		
			}*/
			
			else if(options.pagetype=='setpagesize'){
				pageSize=parseInt($(this).text());
				$('i',$(options.pagesetting.setpagesize)).css('visibility','hidden');
				//$('i '+this).css('visibility','');
				$('i',$(this)).css('visibility','visible');
				$(options.pagesetting.pagesize).attr('value',pageSize);
				pageNo=parseInt(1);
				$(options.pagesetting.pageno).val(1);
				linenum=($(options.pagesetting.tablename+' tr').length-1);
				for(i=1;i<linenum;i++){
					$('tr:eq(1)',$(options.pagesetting.tablename)).remove();
				}
				$('td',$('tr:eq(1)')).html('');
				blank_tr=$('tr:eq(1)',$(options.pagesetting.tablename));
				for(j=1;j<pageSize;j++){
					$('tr:eq(1)',$(options.pagesetting.tablename)).parent().append(blank_tr.clone());
				}
				jQuery.global.main();
			}
				//jQuery.json.setQueryParam();
				/*
				param='pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false';
				$.ajax({
					type:'post', 
					data:param,
					url:options.queryurl,//+'?pageSize='+pageSize+'&pageNo='+pageNo+'&goLastPage=false',
					dataType:'json',
					success: function (data) {
						$(options.pagesetting.tablename+' td').html('');
						jQuery.json.getMSG(data);
						$(options.pagesetting.tablename+' tr').css('display','');
						if(pageMinRow!=0){
							//jQuery.json.getJSON(data);
							jQuery.json.getContent(data,options.jsontype);
							for(j=0;j<=(pageSize-(pageMaxRow-pageMinRow+1));j++){
		                	    $(options.pagesetting.tablename+' tr:eq('+(pageSize-j+1)+')').css('display','none');
		                	}
							if(pageMinRow!=pageMaxRow){
								$(options.pagesetting.pagerow).text(pageMinRow+'-'+pageMaxRow);
							}
							else{
								$(options.pagesetting.pagerow).text(pageMaxRow);
							}
						}
						jQuery.global.pageFlag(firstPageFlag,lastPageFlag);
						//$(options.pagesetting.loading).hide();
						$('.title a',$('#setting')).click();			
					},
					error: function () {
						alert("获取Json数据失败");
					}
				});	
			}*/
			
		});
	}

})(jQuery);